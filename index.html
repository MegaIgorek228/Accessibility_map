<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карта доступности нашего района</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: Arial, sans-serif; 
    }
    #map { 
      width: 100%; 
      height: 100vh; 
    }
    .leaflet-popup-content {
      font-size: 14px;
    }
    .leaflet-popup-content img {
      width: 100%;
      margin-top: 10px;
      border-radius: 4px;
    }
    #control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button:hover { 
      background: #45a049; 
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div id="control-panel">
    <h3>Управление картой</h3>
    <button onclick="loadData()">Обновить карту</button>
    <br>
    <a href="https://docs.google.com/forms/d/1Cyn8VfR6RQKKLt9lm15SllafPy6gaNx6Ih-keJlrATE/edit" target="_blank">
      <button>Добавить новое место</button>
    </a>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Инициализация карты
    var map = L.map('map').setView([55.811436, 37.501846], 16.5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Создаем иконки
    var icons = {
      'доступно': L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      }),
      'частично доступно': L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      }),
      'недоступно': L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    };

    // Добавляем статические маркеры
    function addStaticMarkers() {
      // ЗЕЛЕНЫЕ маркеры
      var gmarker0 = L.marker([55.810476, 37.498286], {icon: icons['доступно']}).addTo(map);
      gmarker0.bindPopup(`<b>Приемная коммисия маи</b><br>Статус: <span style="color: green;">Полностью доступно</span>`);

      var gmarker1 = L.marker([55.810901, 37.498832], {icon: icons['доступно']}).addTo(map);
      gmarker1.bindPopup(`<b>Дворец культуры маи</b><br>Статус: <span style="color: green;">Полностью доступно</span>`);

      // Добавьте остальные статические маркеры аналогично...
      // ЖЕЛТЫЕ маркеры
      var ymarker1 = L.marker([55.811411, 37.498942], {icon: icons['частично доступно']}).addTo(map);
      ymarker1.bindPopup(`<b>Проход</b><br>Статус: <span style="color: orange;">Частично доступно</span>`);

      // КРАСНЫЕ маркеры
      var rmarker1 = L.marker([55.814366, 37.501316], {icon: icons['недоступно']}).addTo(map);
      rmarker1.bindPopup(`<b>Лестница на мост победы</b><br>Статус: <span style="color: red;">Недоступно</span>`);
    }

    // Функция для загрузки данных из Google Apps Script
    function loadData() {
      var API_URL = 'https://script.google.com/macros/s/AKfycbw7WsdO8mPOSQuaQfPw1FKAYDwNlNTXLBBq0co6sXOLpN8V0RLvqjxbKUrAu00qCVxijQ/exec';

      fetch(API_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error('Ошибка сети: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('Данные получены:', data);
          
          // Удаляем только динамические маркеры (те что из Google Sheets)
          // Статические маркеры останутся
          map.eachLayer(layer => {
            if (layer instanceof L.Marker && layer._popup && layer._popup._content.includes('Добавлено:')) {
              map.removeLayer(layer);
            }
          });

          // Добавляем новые маркеры из Google Sheets
          if (data && data.length > 0) {
            data.forEach(point => {
              if (point.lat && point.lng) {
                var marker = L.marker(
                  [point.lat, point.lng],
                  {icon: icons[point.status] || icons['частично доступно']}
                ).addTo(map);

                marker.bindPopup(`
                  <b>${point.name}</b><br>
                  Статус: ${point.status}<br>
                  ${point.description || ''}<br>
                  ${point.photoUrl ? `<img src="${point.photoUrl}" width="200"><br>` : ''}
                  <small>Добавлено: ${point.date || 'не указано'}</small>
                `);
              }
            });
            alert('Данные обновлены! Новых точек: ' + data.length);
          } else {
            alert('Нет новых данных для отображения');
          }
        })
        .catch(error => {
          console.error('Ошибка:', error);
          alert('Ошибка загрузки данных: ' + error.message);
        });
    }

    // Добавляем легенду
    function addLegend() {
      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function(map) {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `
          <h4>Маркеры:</h4>
          <div><span style="color: green;">●</span> Полностью доступно</div>
          <div><span style="color: orange;">●</span> Частично доступно</div>
          <div><span style="color: red;">●</span> Недоступно</div>
        `;
        return div;
      };
      legend.addTo(map);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
      addStaticMarkers();
      addLegend();
      loadData(); // Загружаем данные из Google Sheets
    });
  </script>
</body>
</html>
